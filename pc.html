<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Photobooth — PC</title>
<style>
  body { font-family: Arial, sans-serif; margin: 16px; background:#111; color:#fff; }
  #qrcode { margin-top:20px; }
  #finalMontage { margin-top: 20px; display: none; }
  #finalMontage img { max-width: 400px; border: 3px solid #fff; border-radius: 10px; margin: 10px 0; }
  .controls { margin: 20px 0; }
  button { 
    background: #007bff; 
    color: white; 
    border: none; 
    padding: 12px 24px; 
    margin: 5px; 
    border-radius: 5px; 
    cursor: pointer; 
    font-size: 16px; 
  }
  button:hover { background: #0056b3; }
  button:disabled { background: #666; cursor: not-allowed; }
  .whatsapp-section { margin: 20px 0; padding: 15px; background: #1e1e1e; border-radius: 8px; }
  input { 
    padding: 10px; 
    margin: 5px; 
    border: 1px solid #444; 
    background: #333; 
    color: white; 
    border-radius: 4px; 
    width: 200px;
  }
  .status { 
    padding: 10px; 
    margin: 10px 0; 
    border-radius: 5px; 
    font-weight: bold;
  }
  .waiting { background: #333; }
  .receiving { background: #ffa500; }
  .ready { background: #008000; }
</style>
</head>
<body>
<h1>Photobooth — Controle PC</h1>
<div>Session: <span id="session">—</span></div>

<div id="status" class="status waiting">Aguardando fotos do celular...</div>

<div class="controls">
  <button id="generateControlUrl">Gerar QR Code do Celular</button>
  <button id="generateViewerLink" disabled>Gerar Visualizador Online</button>
  <button id="restartSession" disabled>Reiniciar Sessão</button>
</div>

<div id="qrcode"></div>

<div id="finalMontage">
  <h2>🎉 Foto Final Pronta!</h2>
  <img id="finalImage" src="" alt="Foto Montada">
  
  <div class="whatsapp-section">
    <h3>📤 Compartilhar Foto</h3>
    <input type="text" id="phoneNumber" placeholder="Número WhatsApp (ex: 5511999999999)" />
    <input type="text" id="customMessage" placeholder="Mensagem personalizada" value="Confira minha foto da cabine fotográfica! 🎉" />
    <button id="sendWhatsApp">Enviar via WhatsApp</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const DEFAULT_SOCKET_SERVER = "https://render-9ea7.onrender.com";
const session = 'pc_' + Date.now();
const IMGBB_API_KEY = "substitua_com_sua_chave_imgbb"; // Você precisa conseguir uma API key gratuita

document.getElementById("session").innerText = session;
let socket = io(DEFAULT_SOCKET_SERVER, { transports: ["websocket"] });
let finalImageUrl = null;
let imgbbUrl = null;

socket.on("connect", () => {
  socket.emit("join", { session });
  updateStatus("Conectado - Aguardando celular...", "waiting");
});

socket.on("finalPhoto", (msg) => {
  if (msg.session && msg.finalImage) {
    updateStatus("📸 Foto final recebida!", "receiving");
    
    // Mostra a imagem final
    document.getElementById("finalImage").src = msg.finalImage;
    document.getElementById("finalMontage").style.display = "block";
    finalImageUrl = msg.finalImage;
    
    // Ativa botões
    document.getElementById("generateViewerLink").disabled = false;
    document.getElementById("restartSession").disabled = false;
    
    updateStatus("✅ Foto pronta para compartilhar!", "ready");
  }
});

// Gerar QR Code do celular
document.getElementById("generateControlUrl").onclick = () => {
  const url = location.origin + "/celular.html?session=" + session + "&socket=" + DEFAULT_SOCKET_SERVER;
  showQR(url, "QR Code para Celular");
};

// Gerar visualizador online
document.getElementById("generateViewerLink").onclick = async () => {
  if (!finalImageUrl) return;
  
  updateStatus("⏳ Fazendo upload para nuvem...", "receiving");
  
  try {
    // Faz upload para ImgBB
    imgbbUrl = await uploadToImgBB(finalImageUrl);
    
    // Gera link do visualizador
    const viewerUrl = `${location.origin}/visualizador.html?photo=${encodeURIComponent(imgbbUrl)}`;
    
    updateStatus("✅ Upload concluído!", "ready");
    showQR(viewerUrl, "Visualizador Online");
    
  } catch (error) {
    updateStatus("❌ Erro no upload: " + error.message, "waiting");
    console.error("Upload error:", error);
    
    // Fallback: usa DataURL diretamente (menos ideal)
    const viewerUrl = `${location.origin}/visualizador.html?photo=${encodeURIComponent(finalImageUrl)}`;
    showQR(viewerUrl, "Visualizador Online (Fallback)");
  }
};

// Reiniciar sessão
document.getElementById("restartSession").onclick = () => {
  socket.emit("restartSession", { session });
  document.getElementById("finalMontage").style.display = "none";
  document.getElementById("generateViewerLink").disabled = true;
  document.getElementById("restartSession").disabled = true;
  finalImageUrl = null;
  imgbbUrl = null;
  updateStatus("Aguardando nova sessão...", "waiting");
};

// Enviar WhatsApp
document.getElementById("sendWhatsApp").onclick = () => {
  const phoneNumber = document.getElementById("phoneNumber").value.replace(/\D/g, '');
  const message = document.getElementById("customMessage").value;
  
  if (!phoneNumber) {
    alert("Por favor, insira um número de WhatsApp");
    return;
  }
  
  const shareUrl = imgbbUrl || finalImageUrl;
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message + '\n\n' + shareUrl)}`;
  
  window.open(whatsappUrl, '_blank');
};

// Função para upload no ImgBB
async function uploadToImgBB(dataURL) {
  // Converte DataURL para Blob
  const response = await fetch(dataURL);
  const blob = await response.blob();
  
  // Cria FormData
  const formData = new FormData();
  formData.append('image', blob);
  
  // Faz upload (nota: você precisa de uma API key gratuita do ImgBB)
  const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
    method: 'POST',
    body: formData
  });
  
  const result = await uploadResponse.json();
  
  if (result.success) {
    return result.data.url;
  } else {
    throw new Error(result.error?.message || 'Upload failed');
  }
}

function updateStatus(message, type) {
  const statusEl = document.getElementById("status");
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
}

function showQR(url, title = "") {
  const qrDiv = document.getElementById("qrcode");
  qrDiv.innerHTML = `<h3>${title}</h3>`;
  
  QRCode.toCanvas(url, { width: 200 }, function(err, canvas) {
    if (err) {
      qrDiv.innerHTML += `<p style="color:red">Erro ao gerar QR</p>`;
      return;
    }
    qrDiv.appendChild(canvas);
  });
  
  const link = document.createElement("p");
  link.innerHTML = `<a href="${url}" target="_blank" style="color:#0bf">${url}</a>`;
  qrDiv.appendChild(link);
}
</script>
</body>
</html>
