<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Photobooth ‚Äî PC</title>
<style>
  body { font-family: Arial, sans-serif; margin: 16px; background:#111; color:#fff; }
  #qrcode { margin-top:20px; }
  #finalMontage { margin-top: 20px; display: none; }
  #finalMontage img { max-width: 400px; border: 3px solid #fff; border-radius: 10px; margin: 10px 0; }
  .controls { margin: 20px 0; }
  button { 
    background: #007bff; 
    color: white; 
    border: none; 
    padding: 12px 24px; 
    margin: 5px; 
    border-radius: 5px; 
    cursor: pointer; 
    font-size: 16px; 
  }
  button:hover { background: #0056b3; }
  button:disabled { background: #666; cursor: not-allowed; }
  .whatsapp-section { margin: 20px 0; padding: 15px; background: #1e1e1e; border-radius: 8px; }
  input { 
    padding: 10px; 
    margin: 5px; 
    border: 1px solid #444; 
    background: #333; 
    color: white; 
    border-radius: 4px; 
    width: 200px;
  }
  .status { 
    padding: 10px; 
    margin: 10px 0; 
    border-radius: 5px; 
    font-weight: bold;
  }
  .waiting { background: #333; }
  .receiving { background: #ffa500; }
  .ready { background: #008000; }
  .connected { background: #007bff; }
</style>
</head>
<body>
<h1>Photobooth ‚Äî Controle PC</h1>
<div>Session: <span id="session">‚Äî</span></div>

<div id="status" class="status waiting">Conectando ao servidor...</div>

<div class="controls">
  <button id="generateControlUrl">Gerar QR Code do Celular</button>
  <button id="generateViewerLink" disabled>Gerar Visualizador Online</button>
  <button id="restartSession" disabled>Reiniciar Sess√£o no Celular</button>
</div>

<div id="qrcode"></div>

<div id="finalMontage">
  <h2>üéâ Foto Final Pronta!</h2>
  <img id="finalImage" src="" alt="Foto Montada">
  
  <div class="whatsapp-section">
    <h3>üì§ Compartilhar Foto</h3>
    <input type="text" id="phoneNumber" placeholder="N√∫mero WhatsApp (ex: 5511999999999)" />
    <input type="text" id="customMessage" placeholder="Mensagem personalizada" value="Confira minha foto da cabine fotogr√°fica! üéâ" />
    <button id="sendWhatsApp">Enviar via WhatsApp</button>
    <button id="uploadImgBB" style="background: #28a745;">‚òÅÔ∏è Fazer Upload para ImgBB</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const DEFAULT_SOCKET_SERVER = "https://render-9ea7.onrender.com";
const session = 'pc_' + Date.now();
const IMGBB_API_KEY = "79cf8905f02f40f5572e975eb5a1c0c9"; // API key do ImgBB

document.getElementById("session").innerText = session;
let socket = io(DEFAULT_SOCKET_SERVER, { 
  transports: ["websocket", "polling"],
  timeout: 10000
});

let finalImageUrl = null;
let imgbbUrl = null;

console.log("üñ•Ô∏è PC iniciado - Sess√£o:", session);

// Eventos do Socket
socket.on("connect", () => {
  console.log("‚úÖ Conectado ao servidor Socket.io");
  socket.emit("join_room", { session: session });
  updateStatus("‚úÖ Conectado - Aguardando celular...", "connected");
});

socket.on("disconnect", () => {
  console.log("‚ùå Desconectado do servidor");
  updateStatus("‚ùå Desconectado - Tentando reconectar...", "waiting");
});

socket.on("connect_error", (error) => {
  console.log("‚ùå Erro de conex√£o:", error);
  updateStatus("‚ùå Erro de conex√£o com servidor", "waiting");
});

// OUVINDO A MENSAGEM DO CELULAR - CORRIGIDO
socket.on("final_photo", (data) => {
  console.log("üì® Foto recebida do celular:", data);
  
  if (data && data.finalImage) {
    console.log("‚úÖ Foto final recebida com sucesso!");
    updateStatus("üì∏ Foto recebida! Processando...", "receiving");
    
    // Pequeno delay para garantir o carregamento
    setTimeout(() => {
      // Mostra a imagem final
      document.getElementById("finalImage").src = data.finalImage;
      document.getElementById("finalMontage").style.display = "block";
      finalImageUrl = data.finalImage;
      
      // Ativa bot√µes
      document.getElementById("generateViewerLink").disabled = false;
      document.getElementById("restartSession").disabled = false;
      document.getElementById("uploadImgBB").disabled = false;
      
      updateStatus("‚úÖ Foto pronta para compartilhar!", "ready");
    }, 500);
  }
});

// Tamb√©m escuta o evento antigo para compatibilidade
socket.on("finalPhoto", (data) => {
  console.log("üì® Foto recebida (evento antigo):", data);
  socket.emit("final_photo", data); // Repete com o novo evento
});

// Gerar QR Code do celular
document.getElementById("generateControlUrl").onclick = () => {
  const url = window.location.origin + "/celular.html?session=" + session + "&socket=" + encodeURIComponent(DEFAULT_SOCKET_SERVER);
  showQR(url, "QR Code para Celular");
  updateStatus("üì± QR Code gerado - Escaneie com o celular", "connected");
};

// Gerar visualizador online
document.getElementById("generateViewerLink").onclick = async () => {
  if (!finalImageUrl) {
    alert("Nenhuma foto recebida ainda");
    return;
  }
  
  updateStatus("‚è≥ Gerando link de visualiza√ß√£o...", "receiving");
  
  try {
    // Usa DataURL diretamente (mais simples)
    const viewerUrl = `${window.location.origin}/visualizador.html?photo=${encodeURIComponent(finalImageUrl)}`;
    
    updateStatus("‚úÖ Link gerado com sucesso!", "ready");
    showQR(viewerUrl, "Visualizador Online");
    
  } catch (error) {
    updateStatus("‚ùå Erro ao gerar link: " + error.message, "waiting");
    console.error("Error:", error);
  }
};

// Upload para ImgBB
document.getElementById("uploadImgBB").onclick = async () => {
  if (!finalImageUrl) {
    alert("Nenhuma foto para fazer upload");
    return;
  }
  
  updateStatus("‚è≥ Fazendo upload para ImgBB...", "receiving");
  
  try {
    const uploadedUrl = await uploadToImgBB(finalImageUrl);
    imgbbUrl = uploadedUrl;
    
    updateStatus("‚úÖ Upload conclu√≠do! Link copiado.", "ready");
    
    // Copia URL para √°rea de transfer√™ncia
    await navigator.clipboard.writeText(uploadedUrl);
    alert("‚úÖ Upload conclu√≠do! Link copiado para √°rea de transfer√™ncia:\n" + uploadedUrl);
    
  } catch (error) {
    console.error("‚ùå Erro no upload:", error);
    updateStatus("‚ùå Erro no upload: " + error.message, "waiting");
    alert("‚ùå Erro no upload: " + error.message);
  }
};

// Reiniciar sess√£o no celular
document.getElementById("restartSession").onclick = () => {
  console.log("üîÑ Enviando comando para reiniciar sess√£o no celular");
  socket.emit("restart_session", { session: session });
  updateStatus("üîÑ Comando enviado - Reiniciando celular...", "receiving");
};

// Enviar WhatsApp
document.getElementById("sendWhatsApp").onclick = () => {
  const phoneNumber = document.getElementById("phoneNumber").value.replace(/\D/g, '');
  const message = document.getElementById("customMessage").value;
  
  if (!phoneNumber) {
    alert("Por favor, insira um n√∫mero de WhatsApp");
    return;
  }
  
  const shareUrl = imgbbUrl || finalImageUrl;
  if (!shareUrl) {
    alert("Nenhuma foto dispon√≠vel para compartilhar");
    return;
  }
  
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message + '\n\n' + shareUrl)}`;
  window.open(whatsappUrl, '_blank');
};

// Fun√ß√£o para upload no ImgBB
async function uploadToImgBB(dataURL) {
  console.log("üì§ Iniciando upload para ImgBB...");
  
  // Converte DataURL para Blob
  const response = await fetch(dataURL);
  const blob = await response.blob();
  
  // Cria FormData
  const formData = new FormData();
  formData.append('image', blob);
  
  // Faz upload
  const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
    method: 'POST',
    body: formData
  });
  
  const result = await uploadResponse.json();
  console.log("üì§ Resposta do ImgBB:", result);
  
  if (result.success) {
    return result.data.url;
  } else {
    throw new Error(result.error?.message || 'Falha no upload');
  }
}

function updateStatus(message, type) {
  const statusEl = document.getElementById("status");
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
}

function showQR(url, title = "") {
  const qrDiv = document.getElementById("qrcode");
  qrDiv.innerHTML = `<h3>${title}</h3>`;
  
  // Limpa QR code anterior
  QRCode.toCanvas(url, { width: 200, margin: 2 }, function(err, canvas) {
    if (err) {
      qrDiv.innerHTML += `<p style="color:red">Erro ao gerar QR: ${err.message}</p>`;
      return;
    }
    
    // Remove canvas anterior se existir
    const oldCanvas = qrDiv.querySelector('canvas');
    if (oldCanvas) oldCanvas.remove();
    
    qrDiv.appendChild(canvas);
  });
  
  // Atualiza link
  const oldLink = qrDiv.querySelector('p');
  if (oldLink) oldLink.remove();
  
  const link = document.createElement("p");
  link.innerHTML = `<a href="${url}" target="_blank" style="color:#0bf">${url}</a>`;
  qrDiv.appendChild(link);
}

// Teste de conex√£o peri√≥dico
setInterval(() => {
  if (!socket.connected) {
    console.log("üîÑ Tentando reconectar...");
    socket.connect();
  }
}, 5000);
</script>
</body>
</html>
