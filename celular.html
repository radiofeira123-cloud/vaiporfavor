<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Photobooth â€” Celular</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#111;color:#fff;flex-direction:column;text-align:center}
  button{font-size:24px;padding:20px 40px;margin:10px;border:none;border-radius:8px;cursor:pointer}
  #count{font-size:64px;margin-top:20px}
  #status{margin-top:10px;font-size:20px}
  video{width:100%;max-width:400px;border-radius:8px;margin-top:20px}
</style>
</head>
<body>
  <div id="step1">
    <button id="fullscreenBtn">Entrar em tela cheia</button>
  </div>
  <div id="step2" style="display:none">
    <button id="startSessionBtn">Iniciar sessÃ£o</button>
  </div>
  <div id="step3" style="display:none">
    <div id="count"></div>
    <div id="status"></div>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const DEFAULT_SOCKET_SERVER="https://render-9ea7.onrender.com";
const params=new URLSearchParams(location.search);
const session=params.get('session')||('ctrl_'+Date.now());
const socketServer=(params.get('socket')||DEFAULT_SOCKET_SERVER).replace(/\/$/,'');
let socket=null;let awaiting=null;

function enterFullscreen(){
  const el=document.documentElement;
  if(el.requestFullscreen) el.requestFullscreen();
  if(screen.orientation&&screen.orientation.lock){
    screen.orientation.lock('landscape').catch(()=>{});
  }
}

document.getElementById("fullscreenBtn").onclick=()=>{
  enterFullscreen();
  document.getElementById("step1").style.display="none";
  document.getElementById("step2").style.display="block";
};

document.getElementById("startSessionBtn").onclick=()=>{
  socket=io(socketServer,{transports:["websocket"]});
  socket.on("connect",()=>{
    socket.emit("join",{session});
    document.getElementById("status").innerText="Conectado!";
    document.getElementById("step2").style.display="none";
    document.getElementById("step3").style.display="block";
    startCamera();
  });

  socket.on("triggerPhoto",()=>{
    startSequence();
  });
};

function startCamera(){
  const videoEl=document.getElementById("video");
  navigator.mediaDevices.getUserMedia({ video:true }).then(stream=>{
    videoEl.srcObject=stream;
  }).catch(err=>{
    document.getElementById("status").innerText="Erro ao abrir cÃ¢mera: "+err;
  });
}

async function startSequence(){
  let count=3;
  document.getElementById("count").innerText=count;
  const interval=setInterval(()=>{
    count--;
    if(count>0){
      document.getElementById("count").innerText=count;
    }else{
      clearInterval(interval);
      document.getElementById("count").innerText="";
      captureAndSend();
    }
  },1000);
}

function captureAndSend(){
  const videoEl=document.getElementById("video");
  const canvasEl=document.getElementById("canvas");
  const ctx=canvasEl.getContext("2d");
  canvasEl.width=videoEl.videoWidth;
  canvasEl.height=videoEl.videoHeight;
  ctx.drawImage(videoEl,0,0);
  const dataURL=canvasEl.toDataURL("image/jpeg");
  socket.emit("photo",{session,dataURL});
  document.getElementById("status").innerText="ðŸ“¸ Foto enviada!";
}
</script>
</body>
</html>
