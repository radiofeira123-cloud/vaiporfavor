<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Photobooth ‚Äî Celular</title>
<style>
body { 
  font-family: sans-serif; 
  text-align: center; 
  background: #111; 
  color: #fff; 
  margin: 0;
  padding: 20px;
}
video, canvas { 
  width: 100%; 
  max-width: 400px; 
  border: 2px solid #fff; 
  margin: 10px auto; 
  display: block; 
  border-radius: 10px;
}
#status { 
  margin: 20px; 
  font-size: 1.2em; 
  font-weight: bold;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}
button { 
  font-size: 1.2em; 
  padding: 15px 30px; 
  margin: 10px; 
  background: #007bff;
  color: white;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  transition: all 0.3s;
}
button:hover {
  background: #0056b3;
  transform: scale(1.05);
}
button:disabled {
  background: #666;
  cursor: not-allowed;
  transform: none;
}
.countdown {
  font-size: 3em;
  font-weight: bold;
  color: #ffa500;
  text-shadow: 0 0 10px rgba(255,165,0,0.5);
}
.success { 
  color: #00ff00; 
  font-size: 1.4em;
}
</style>
</head>
<body>
<h2>üì∏ Cabine Fotogr√°fica</h2>
<video id="preview" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<div id="status">Conectado. Clique em "Iniciar Sess√£o" para come√ßar!</div>
<button id="startBtn">Iniciar Sess√£o</button>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let video = document.getElementById('preview');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let statusEl = document.getElementById('status');
let startBtn = document.getElementById('startBtn');
let session = new URLSearchParams(window.location.search).get("session");
let socketURL = new URLSearchParams(window.location.search).get("socket");
let socket = io(socketURL);
let localStream;
let isSessionActive = false;

// Verifica se os par√¢metros necess√°rios est√£o presentes
if(!session || !socketURL) {
  statusEl.innerHTML = '‚ùå Erro: Link inv√°lido. Use o QR code gerado no PC.';
  startBtn.disabled = true;
}

socket.on('connect', () => {
  statusEl.innerHTML = '‚úÖ Conectado! Clique em "Iniciar Sess√£o"';
});

socket.on('disconnect', () => {
  statusEl.innerHTML = '‚ùå Desconectado do servidor';
});

async function initCamera(){
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: "user",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }, 
      audio: false 
    });
    video.srcObject = localStream;
  } catch (error) {
    statusEl.innerHTML = '‚ùå Erro ao acessar a c√¢mera: ' + error.message;
    startBtn.disabled = true;
  }
}

initCamera();

startBtn.onclick = () => {
  if(isSessionActive) return;
  
  isSessionActive = true;
  startBtn.disabled = true;
  startBtn.textContent = "Sess√£o em Andamento...";
  statusEl.innerHTML = 'üé¨ <strong>Prepare-se!</strong> A sess√£o vai come√ßar...';
  
  setTimeout(startSequence, 2000);
};

async function startSequence(){
  try {
    for(let i=1;i<=3;i++){
      await countdown(3, i);
      await takePhoto(i);
      if(i<3) {
        statusEl.innerHTML = `üì∏ Foto ${i} capturada! Pr√≥xima em 3 segundos...`;
        await delay(3000);
      }
    }
    statusEl.innerHTML = '<div class="success">‚úÖ Fotos enviadas com sucesso! Obrigado! üéâ</div>';
    
    // Prepara para pr√≥xima sess√£o ap√≥s 5 segundos
    setTimeout(() => {
      isSessionActive = false;
      startBtn.disabled = false;
      startBtn.textContent = "Iniciar Sess√£o";
      statusEl.innerHTML = '‚úÖ Pronto para nova sess√£o! Clique em "Iniciar Sess√£o"';
    }, 5000);
    
  } catch (error) {
    statusEl.innerHTML = '‚ùå Erro durante a sess√£o: ' + error.message;
    isSessionActive = false;
    startBtn.disabled = false;
    startBtn.textContent = "Tentar Novamente";
  }
}

function countdown(sec, photoNumber){
  return new Promise(resolve=>{
    let c = sec;
    statusEl.innerHTML = `<div class="countdown">${c}</div><div>Foto ${photoNumber} em...</div>`;
    
    let interval = setInterval(()=>{
      c--;
      if(c>0){
        statusEl.innerHTML = `<div class="countdown">${c}</div><div>Foto ${photoNumber} em...</div>`;
      } else {
        clearInterval(interval);
        statusEl.innerHTML = '<div class="countdown">üì∏</div><div>Smile!</div>';
        setTimeout(resolve, 500);
      }
    },1000);
  });
}

async function takePhoto(i){
  try {
    // Configura o canvas com as dimens√µes do v√≠deo
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Desenha o frame atual do v√≠deo no canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Converte para DataURL (SEM MOLDURA)
    let dataUrl = canvas.toDataURL("image/png");
    
    // Envia via Socket.io
    socket.emit("photo", {
      session: session, 
      img: dataUrl, 
      index: i,
      timestamp: Date.now()
    });
    
    statusEl.innerHTML = `‚úÖ Foto ${i} enviada!`;
    
  } catch (error) {
    console.error('Erro ao tirar foto:', error);
    throw error;
  }
}

function delay(ms){ 
  return new Promise(r=>setTimeout(r,ms)); 
}

// Tratamento de erro global
window.addEventListener('error', (e) => {
  console.error('Erro global:', e.error);
  statusEl.innerHTML = '‚ùå Ocorreu um erro. Recarregue a p√°gina.';
});
</script>
</body>
</html>
