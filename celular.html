<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cabine de Fotos - Celular</title>
  <style>
    body, html { margin:0; padding:0; background:black; color:white; font-family:Arial; text-align:center; }
    #preview, #frozenPreview { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; }
    #countdown, #message { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-size:5em; }
    #message { font-size:3em; }
    #thankyou { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:3em; }
  </style>
</head>
<body>
  <video id="preview" autoplay playsinline></video>
  <canvas id="frozenPreview" style="display:none;"></canvas>
  <div id="countdown"></div>
  <div id="message"></div>
  <div id="thankyou">üôè Obrigado por usar a cabine!</div>

  <audio id="clack" src="clack.mp3"></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const video = document.getElementById('preview');
    const frozenPreview = document.getElementById('frozenPreview');
    const ctx = frozenPreview.getContext('2d');
    const countdownEl = document.getElementById('countdown');
    const messageEl = document.getElementById('message');
    const thankyouEl = document.getElementById('thankyou');
    const clack = document.getElementById('clack');

    let photoCount = 0;
    let totalPhotos = 3;

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; });

    async function takePhotoSequence() {
      for (let i = 0; i < totalPhotos; i++) {
        await startCountdown();
        capturePhoto();
        await wait(3000); // 3s congelada
      }
      endSequence();
    }

    function startCountdown() {
      return new Promise(resolve => {
        let count = 5;
        countdownEl.textContent = count;
        const interval = setInterval(() => {
          count--;
          countdownEl.textContent = count;
          if (count === 2) clack.play();
          if (count === 1) messageEl.textContent = "SORRIA üì∏";
          if (count === 0) {
            clearInterval(interval);
            countdownEl.textContent = "";
            messageEl.textContent = "";
            resolve();
          }
        }, 1000);
      });
    }

    function capturePhoto() {
      frozenPreview.width = video.videoWidth;
      frozenPreview.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, frozenPreview.width, frozenPreview.height);
      frozenPreview.style.display = "block";

      const dataUrl = frozenPreview.toDataURL('image/png');
      socket.emit('final_photo', { photo: dataUrl });

      setTimeout(() => { frozenPreview.style.display = "none"; }, 3000);
    }

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    function endSequence() {
      video.style.display = "none";
      frozenPreview.style.display = "none";
      countdownEl.style.display = "none";
      messageEl.style.display = "none";
      thankyouEl.style.display = "block";
    }

    // inicia
    takePhotoSequence();
  </script>
</body>
</html>
