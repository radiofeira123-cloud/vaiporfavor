<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Photobooth ‚Äî Celular</title>
<style>
body { font-family: sans-serif; text-align: center; background: #111; color: #fff; }
video, canvas { width: 100%; max-width: 400px; border: 2px solid #fff; margin: 10px auto; display: block; }
#status { margin: 20px; font-size: 1.2em; }
button { font-size: 1.2em; padding: 10px 20px; margin: 10px; }
</style>
</head>
<body>
<h2>Cabine Fotogr√°fica ‚Äî Controle</h2>
<video id="preview" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<div id="status">Conectado. Clique em iniciar sess√£o.</div>
<button id="startBtn">Iniciar sess√£o</button>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
let video = document.getElementById('preview');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let statusEl = document.getElementById('status');
let startBtn = document.getElementById('startBtn');
let session = new URLSearchParams(window.location.search).get("session");
let socketURL = new URLSearchParams(window.location.search).get("socket");
let socket = io(socketURL);
let localStream;
let frameImg = new Image();
frameImg.src = "moldura.png"; // moldura local na raiz

async function initCamera(){
  localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
  video.srcObject = localStream;
}

initCamera();

startBtn.onclick = () => {
  statusEl.innerText = "Prepare-se!";
  setTimeout(startSequence, 2000);
};

async function startSequence(){
  for(let i=1;i<=3;i++){
    await countdown(3);
    await takePhoto(i);
    if(i<3) await delay(3000);
  }
  statusEl.innerText = "‚úîÔ∏è Fotos enviadas com sucesso!";
}

function countdown(sec){
  return new Promise(resolve=>{
    let c = sec;
    statusEl.innerText = "Foto em... " + c;
    let interval = setInterval(()=>{
      c--;
      if(c>0){
        statusEl.innerText = "Foto em... " + c;
      } else {
        clearInterval(interval);
        resolve();
      }
    },1000);
  });
}

async function takePhoto(i){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  // Garante que a moldura carregou
  await new Promise(r=>{ if(frameImg.complete) r(); else frameImg.onload=r; });
  ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
  let dataUrl = canvas.toDataURL("image/png");
  socket.emit("photo",{session:session, img:dataUrl, index:i});
  statusEl.innerText = "üì∏ Foto " + i;
}
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>
