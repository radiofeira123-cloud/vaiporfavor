<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cabine Fotogr√°fica</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  touch-action: manipulation;
}
.screen {
  width: 100%;
  height: 100%;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 20px;
}
#welcomeScreen {
  display: flex;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
#startScreen {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}
#cameraScreen {
  background: #000;
}
#resultScreen {
  background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
}
h1 {
  font-size: 2.5em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}
h2 {
  font-size: 2em;
  margin-bottom: 30px;
}
button {
  font-size: 1.5em;
  padding: 20px 40px;
  background: #fff;
  color: #333;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  margin: 10px;
  font-weight: bold;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  transition: all 0.3s;
}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}
video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top: 0;
  left: 0;
}
canvas {
  display: none;
}
#countdown {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 8em;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 0 20px rgba(255,255,255,0.8);
  z-index: 100;
}
#photoCounter {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.5em;
  background: rgba(0,0,0,0.7);
  padding: 10px 20px;
  border-radius: 20px;
  z-index: 100;
}
#finalImage {
  max-width: 90%;
  max-height: 70%;
  border: 10px solid white;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  margin-bottom: 30px;
}
.thankYou {
  font-size: 3em;
  font-weight: bold;
  margin-top: 30px;
  animation: pulse 2s infinite;
}
.error {
  color: #ff4444;
  background: rgba(255,68,68,0.1);
  padding: 15px;
  border-radius: 10px;
  margin: 10px 0;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
</style>
</head>
<body>
<!-- Tela de Boas-Vindas -->
<div id="welcomeScreen" class="screen">
  <h1>üéâ Cabine Fotogr√°fica</h1>
  <h2>Bem-vindo!</h2>
  <button id="enterFullscreen">üöÄ ENTRAR EM TELA CHEIA</button>
  <button id="skipFullscreen" style="background: transparent; color: white; border: 2px solid white;">‚è≠Ô∏è PULAR TELA CHEIA</button>
</div>

<!-- Tela de In√≠cio -->
<div id="startScreen" class="screen">
  <h1>üì∏ Cabine Fotogr√°fica</h1>
  <h2>Prepare-se para a divers√£o!</h2>
  <button id="startSession">üé¨ CLIQUE AQUI PARA COME√áAR</button>
</div>

<!-- Tela da C√¢mera -->
<div id="cameraScreen" class="screen">
  <video id="preview" autoplay playsinline></video>
  <div id="countdown"></div>
  <div id="photoCounter"></div>
</div>

<!-- Tela de Resultado -->
<div id="resultScreen" class="screen">
  <h1>üéâ Sua Foto Pronta!</h1>
  <img id="finalImage" src="" alt="Foto Montada">
  <div class="thankYou">Obrigado! ü•∞</div>
</div>

<canvas id="canvas"></canvas>
<canvas id="montageCanvas"></canvas>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
// Elementos
const welcomeScreen = document.getElementById('welcomeScreen');
const startScreen = document.getElementById('startScreen');
const cameraScreen = document.getElementById('cameraScreen');
const resultScreen = document.getElementById('resultScreen');
const video = document.getElementById('preview');
const canvas = document.getElementById('canvas');
const montageCanvas = document.getElementById('montageCanvas');
const countdownEl = document.getElementById('countdown');
const photoCounterEl = document.getElementById('photoCounter');
const finalImageEl = document.getElementById('finalImage');
const enterFullscreenBtn = document.getElementById('enterFullscreen');
const skipFullscreenBtn = document.getElementById('skipFullscreen');
const startSessionBtn = document.getElementById('startSession');

const ctx = canvas.getContext('2d');
const montageCtx = montageCanvas.getContext('2d');

// Configura√ß√µes
const session = new URLSearchParams(window.location.search).get("session");
const socketURL = new URLSearchParams(window.location.search).get("socket");
let socket = io(socketURL, { transports: ['websocket'] });
let localStream;
let photos = [];
let templateImage = new Image();
let templateLoaded = false;

// COORDENADAS para 6000x3375 (VERTICAL)
const photoAreas = [
  { number: 1, x: 446, y: 800, width: 800, height: 600 },
  { number: 2, x: 446, y: 1600, width: 800, height: 600 },
  { number: 3, x: 446, y: 2400, width: 800, height: 600 }
];

// Tenta carregar o template
templateImage.src = "moldura.png";
templateImage.onload = () => {
  console.log("‚úÖ Template carregado com sucesso");
  templateLoaded = true;
};
templateImage.onerror = () => {
  console.log("‚ö†Ô∏è Template n√£o encontrado, usando fallback");
  templateLoaded = false;
  createFallbackTemplate();
};

function createFallbackTemplate() {
  const fallbackCanvas = document.createElement('canvas');
  fallbackCanvas.width = 3375;
  fallbackCanvas.height = 6000;
  const fallbackCtx = fallbackCanvas.getContext('2d');
  
  // Fundo
  const gradient = fallbackCtx.createLinearGradient(0, 0, 3375, 6000);
  gradient.addColorStop(0, '#667eea');
  gradient.addColorStop(1, '#764ba2');
  fallbackCtx.fillStyle = gradient;
  fallbackCtx.fillRect(0, 0, 3375, 6000);
  
  // T√≠tulo
  fallbackCtx.fillStyle = 'white';
  fallbackCtx.font = 'bold 120px Arial';
  fallbackCtx.textAlign = 'center';
  fallbackCtx.fillText('üì∏ CABINE FOTOGR√ÅFICA', 3375/2, 500);
  
  templateImage.src = fallbackCanvas.toDataURL();
  templateLoaded = true;
}

// Mostra tela inicial imediatamente (sem fullscreen)
window.addEventListener('load', () => {
  welcomeScreen.style.display = 'flex';
});

// Entrar em tela cheia - CORRIGIDO
enterFullscreenBtn.addEventListener('click', () => {
  if (document.documentElement.requestFullscreen) {
    document.documentElement.requestFullscreen()
      .then(() => {
        console.log('‚úÖ Entrou em tela cheia');
        goToStartScreen();
      })
      .catch(error => {
        console.log('‚ùå Fullscreen n√£o permitido:', error);
        goToStartScreen();
      });
  } else {
    goToStartScreen();
  }
});

// Pular tela cheia
skipFullscreenBtn.addEventListener('click', goToStartScreen);

function goToStartScreen() {
  welcomeScreen.style.display = 'none';
  startScreen.style.display = 'flex';
}

// Iniciar sess√£o
startSessionBtn.addEventListener('click', startPhotoSession);

async function startPhotoSession() {
  try {
    startScreen.style.display = 'none';
    cameraScreen.style.display = 'flex';
    
    // Inicializa c√¢mera
    if (!localStream) {
      localStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "user" }, 
        audio: false 
      });
      video.srcObject = localStream;
    }
    
    // Inicia sequ√™ncia de fotos
    await takePhotoSequence();
    
  } catch (error) {
    console.error('Erro na sess√£o:', error);
    showError('Erro ao acessar a c√¢mera: ' + error.message);
  }
}

async function takePhotoSequence() {
  photos = [];
  
  for (let i = 1; i <= 3; i++) {
    photoCounterEl.textContent = `Foto ${i} de 3`;
    
    // Contagem regressiva
    await countdown(3);
    
    // Tira foto
    await takePhoto(i);
    
    // Pausa entre fotos
    if (i < 3) {
      countdownEl.textContent = "üí´";
      await delay(2000);
    }
  }
  
  // Cria montagem final
  await createFinalMontage();
  
  // Mostra resultado
  showResult();
}

function countdown(seconds) {
  return new Promise(resolve => {
    let count = seconds;
    
    const interval = setInterval(() => {
      countdownEl.textContent = count > 0 ? count : "üì∏";
      count--;
      
      if (count < -1) {
        clearInterval(interval);
        resolve();
      }
    }, 1000);
  });
}

async function takePhoto(index) {
  return new Promise((resolve) => {
    setTimeout(() => {
      try {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const dataURL = canvas.toDataURL('image/png');
        photos[index] = dataURL;
        console.log(`‚úÖ Foto ${index} capturada`);
      } catch (error) {
        console.error('Erro ao capturar foto:', error);
      }
      resolve();
    }, 100);
  });
}

async function createFinalMontage() {
  return new Promise((resolve) => {
    const checkTemplate = () => {
      if (templateLoaded) {
        // Tamanho do template VERTICAL 3375x6000
        montageCanvas.width = 3375;
        montageCanvas.height = 6000;
        
        // Limpa e desenha template
        montageCtx.clearRect(0, 0, montageCanvas.width, montageCanvas.height);
        montageCtx.drawImage(templateImage, 0, 0, montageCanvas.width, montageCanvas.height);
        
        let loadedPhotos = 0;
        const totalPhotos = 3;
        
        // Desenha cada foto na posi√ß√£o correta
        photoAreas.forEach(area => {
          if (photos[area.number]) {
            const img = new Image();
            img.onload = () => {
              try {
                // Desenha a foto redimensionada para caber na √°rea
                montageCtx.drawImage(img, area.x, area.y, area.width, area.height);
                console.log(`‚úÖ Foto ${area.number} posicionada`);
              } catch (error) {
                console.error(`Erro ao desenhar foto ${area.number}:`, error);
              }
              
              loadedPhotos++;
              if (loadedPhotos === totalPhotos) {
                finalizeMontage();
                resolve();
              }
            };
            img.onerror = () => {
              console.error(`Erro ao carregar foto ${area.number}`);
              loadedPhotos++;
              if (loadedPhotos === totalPhotos) {
                finalizeMontage();
                resolve();
              }
            };
            img.src = photos[area.number];
          }
        });
      } else {
        setTimeout(checkTemplate, 100);
      }
    };
    
    function finalizeMontage() {
      try {
        const finalDataURL = montageCanvas.toDataURL('image/png');
        finalImageEl.src = finalDataURL;
        
        // ENVIA PARA O PC
        console.log("üì§ Enviando foto para PC...");
        socket.emit('finalPhoto', {
          session: session,
          finalImage: finalDataURL,
          timestamp: Date.now()
        });
        
        console.log("‚úÖ Foto enviada para PC");
      } catch (error) {
        console.error("‚ùå Erro ao enviar para PC:", error);
      }
    }
    
    checkTemplate();
  });
}

function showResult() {
  cameraScreen.style.display = 'none';
  resultScreen.style.display = 'flex';
  
  // Ap√≥s 10 segundos, mostra apenas "obrigado"
  setTimeout(() => {
    document.querySelector('#resultScreen h1').style.display = 'none';
    finalImageEl.style.display = 'none';
  }, 10000);
}

function showError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error';
  errorDiv.textContent = message;
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    errorDiv.remove();
    startScreen.style.display = 'flex';
    cameraScreen.style.display = 'none';
  }, 5000);
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Socket events
socket.on('connect', () => {
  console.log('‚úÖ Conectado ao servidor');
});

socket.on('disconnect', () => {
  console.log('‚ùå Desconectado do servidor');
});

socket.on('restartSession', () => {
  console.log('üîÑ Reiniciando sess√£o...');
  resultScreen.style.display = 'none';
  startScreen.style.display = 'flex';
});

// Orienta√ß√£o da tela
screen.orientation.lock('portrait').catch(() => {
  console.log('Orienta√ß√£o portrait n√£o suportada');
});
</script>
</body>
</html>
