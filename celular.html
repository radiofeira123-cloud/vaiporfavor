<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Photobooth — Celular</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#111;color:#fff;flex-direction:column;text-align:center}
  button{font-size:24px;padding:20px 40px;margin:10px;border:none;border-radius:8px;cursor:pointer}
  #count{font-size:64px;margin-top:20px}
  #status{margin-top:10px;font-size:20px}
</style>
</head>
<body>
  <div id="step1">
    <button id="fullscreenBtn">Entrar em tela cheia</button>
  </div>
  <div id="step2" style="display:none">
    <button id="startSessionBtn">Iniciar sessão</button>
  </div>
  <div id="step3" style="display:none">
    <div id="count"></div>
    <div id="status"></div>
  </div>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const DEFAULT_SOCKET_SERVER="https://render-9ea7.onrender.com";
const params=new URLSearchParams(location.search);
const session=params.get('session')||('ctrl_'+Date.now());
const socketServer=(params.get('socket')||DEFAULT_SOCKET_SERVER).replace(/\/$/,'');
let socket=null;let awaiting=null;

function enterFullscreen(){const el=document.documentElement;if(el.requestFullscreen)el.requestFullscreen();if(screen.orientation&&screen.orientation.lock){screen.orientation.lock('landscape').catch(()=>{});}}
async function startSequence(){document.getElementById('step2').style.display='none';document.getElementById('step3').style.display='block';const delays=[10,5,5];for(let i=0;i<3;i++){await countdown(delays[i],'Foto '+(i+1));document.getElementById('status').innerText='Fotografia sendo capturada...';socket.emit('controller:take-photo',{i});await new Promise(res=>awaiting=res);document.getElementById('status').innerText='Foto '+(i+1)+' capturada';await sleep(500);}document.getElementById('status').innerText='Sessão concluída';}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function countdown(sec,msg){return new Promise(r=>{let s=sec;const el=document.getElementById('count');el.innerText=msg+' '+s;const t=setInterval(()=>{s--;el.innerText=msg+' '+s;if(s<=0){clearInterval(t);r();}},1000);});}
function initSocket(){socket=io(socketServer,{query:{session,role:'controller'}});socket.on('pc:photo',()=>{if(awaiting){awaiting();awaiting=null;}});socket.on('pc:reset',()=>{document.getElementById('step3').style.display='none';document.getElementById('step2').style.display='block';document.getElementById('count').innerText='';document.getElementById('status').innerText='Sessão reiniciada';});}
document.getElementById('fullscreenBtn').onclick=()=>{enterFullscreen();document.getElementById('step1').style.display='none';document.getElementById('step2').style.display='block';};
document.getElementById('startSessionBtn').onclick=()=>{initSocket();startSequence();};
</script>
</body></html>