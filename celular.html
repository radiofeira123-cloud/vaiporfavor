<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cabine FotogrÃ¡fica</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}
.screen {
  width: 100%;
  height: 100%;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 20px;
}
#welcomeScreen {
  display: flex;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
#cameraScreen {
  background: #000;
}
#resultScreen {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}
h1 {
  font-size: 2.5em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}
h2 {
  font-size: 2em;
  margin-bottom: 30px;
}
button {
  font-size: 1.5em;
  padding: 20px 40px;
  background: #fff;
  color: #333;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  margin: 10px;
  font-weight: bold;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  transition: all 0.3s;
}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}
video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top: 0;
  left: 0;
}
canvas {
  display: none;
}
#countdown {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 8em;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 0 20px rgba(255,255,255,0.8);
  z-index: 100;
}
#photoCounter {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.5em;
  background: rgba(0,0,0,0.7);
  padding: 10px 20px;
  border-radius: 20px;
  z-index: 100;
}
#finalImage {
  max-width: 90%;
  max-height: 70%;
  border: 10px solid white;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  margin-bottom: 30px;
}
.thankYou {
  font-size: 3em;
  font-weight: bold;
  margin-top: 30px;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
</style>
</head>
<body>
<!-- Tela de Boas-Vindas -->
<div id="welcomeScreen" class="screen">
  <h1>ðŸŽ‰ Cabine FotogrÃ¡fica</h1>
  <h2>Bem-vindo!</h2>
  <button id="enterFullscreen">ðŸš€ ENTRAR EM TELA CHEIA</button>
</div>

<!-- Tela de InÃ­cio -->
<div id="startScreen" class="screen">
  <h1>ðŸ“¸ Cabine FotogrÃ¡fica</h1>
  <h2>Prepare-se para a diversÃ£o!</h2>
  <button id="startSession">ðŸŽ¬ CLIQUE AQUI PARA COMEÃ‡AR</button>
</div>

<!-- Tela da CÃ¢mera -->
<div id="cameraScreen" class="screen">
  <video id="preview" autoplay playsinline></video>
  <div id="countdown"></div>
  <div id="photoCounter"></div>
</div>

<!-- Tela de Resultado -->
<div id="resultScreen" class="screen">
  <h1>ðŸŽ‰ Sua Foto Pronta!</h1>
  <img id="finalImage" src="" alt="Foto Montada">
  <div class="thankYou">Obrigado! ðŸ¥°</div>
</div>

<canvas id="canvas"></canvas>
<canvas id="montageCanvas"></canvas>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
// Elementos
const welcomeScreen = document.getElementById('welcomeScreen');
const startScreen = document.getElementById('startScreen');
const cameraScreen = document.getElementById('cameraScreen');
const resultScreen = document.getElementById('resultScreen');
const video = document.getElementById('preview');
const canvas = document.getElementById('canvas');
const montageCanvas = document.getElementById('montageCanvas');
const countdownEl = document.getElementById('countdown');
const photoCounterEl = document.getElementById('photoCounter');
const finalImageEl = document.getElementById('finalImage');
const enterFullscreenBtn = document.getElementById('enterFullscreen');
const startSessionBtn = document.getElementById('startSession');

const ctx = canvas.getContext('2d');
const montageCtx = montageCanvas.getContext('2d');

// ConfiguraÃ§Ãµes
const session = new URLSearchParams(window.location.search).get("session");
const socketURL = new URLSearchParams(window.location.search).get("socket");
let socket = io(socketURL);
let localStream;
let photos = [];
let templateImage = new Image();

// Coordenadas do template (as mesmas que vocÃª definiu)
const photoAreas = [
  { number: 1, x: 446, y: 48, width: 203, height: 130 },
  { number: 2, x: 446, y: 189, width: 203, height: 129 },
  { number: 3, x: 446, y: 329, width: 203, height: 131 }
];

// Carrega o template
templateImage.src = "caralho.png";

// Entrar em tela cheia
enterFullscreenBtn.addEventListener('click', () => {
  document.documentElement.requestFullscreen().then(() => {
    welcomeScreen.style.display = 'none';
    startScreen.style.display = 'flex';
  });
});

// Iniciar sessÃ£o
startSessionBtn.addEventListener('click', startPhotoSession);

async function startPhotoSession() {
  try {
    startScreen.style.display = 'none';
    cameraScreen.style.display = 'flex';
    
    // Inicializa cÃ¢mera
    if (!localStream) {
      localStream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "user" }, 
        audio: false 
      });
      video.srcObject = localStream;
    }
    
    // Inicia sequÃªncia de fotos
    await takePhotoSequence();
    
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao acessar a cÃ¢mera');
  }
}

async function takePhotoSequence() {
  photos = [];
  
  for (let i = 1; i <= 3; i++) {
    photoCounterEl.textContent = `Foto ${i} de 3`;
    
    // Contagem regressiva
    await countdown(3);
    
    // Tira foto
    await takePhoto(i);
    
    // Pausa entre fotos (exceto apÃ³s a Ãºltima)
    if (i < 3) {
      countdownEl.textContent = "ðŸ’«";
      await delay(2000);
    }
  }
  
  // Cria montagem final
  await createFinalMontage();
  
  // Mostra resultado
  showResult();
}

function countdown(seconds) {
  return new Promise(resolve => {
    let count = seconds;
    
    const interval = setInterval(() => {
      countdownEl.textContent = count;
      count--;
      
      if (count < 0) {
        countdownEl.textContent = "ðŸ“¸";
        clearInterval(interval);
        setTimeout(resolve, 500);
      }
    }, 1000);
  });
}

async function takePhoto(index) {
  return new Promise(resolve => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const dataURL = canvas.toDataURL('image/png');
    photos[index] = dataURL;
    
    resolve();
  });
}

async function createFinalMontage() {
  return new Promise(resolve => {
    templateImage.onload = () => {
      montageCanvas.width = 3375;
      montageCanvas.height = 6000;
      
      // Desenha template
      montageCtx.drawImage(templateImage, 0, 0, montageCanvas.width, montageCanvas.height);
      
      let loadedPhotos = 0;
      
      // Desenha cada foto na posiÃ§Ã£o correta
      photoAreas.forEach(area => {
        const img = new Image();
        img.onload = () => {
          montageCtx.drawImage(img, area.x, area.y, area.width, area.height);
          loadedPhotos++;
          
          if (loadedPhotos === 3) {
            // Converte para DataURL e envia para PC
            const finalDataURL = montageCanvas.toDataURL('image/png');
            finalImageEl.src = finalDataURL;
            
            // Envia para PC
            socket.emit('finalPhoto', {
              session: session,
              finalImage: finalDataURL,
              timestamp: Date.now()
            });
            
            resolve();
          }
        };
        img.src = photos[area.number];
      });
    };
    
    // Se template jÃ¡ estiver carregado
    if (templateImage.complete) {
      templateImage.onload();
    }
  });
}

function showResult() {
  cameraScreen.style.display = 'none';
  resultScreen.style.display = 'flex';
  
  // ApÃ³s 10 segundos, mostra "obrigado"
  setTimeout(() => {
    document.querySelector('h1').style.display = 'none';
    finalImageEl.style.display = 'none';
  }, 10000);
  
  // Aguarda sinal do PC para reiniciar
  socket.on('restartSession', () => {
    resultScreen.style.display = 'none';
    startScreen.style.display = 'flex';
  });
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Sai do fullscreen se apertar ESC
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  }
});
</script>
</body>
</html>
